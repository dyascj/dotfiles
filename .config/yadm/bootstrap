#!/bin/bash
set -e

echo "==> Starting yadm bootstrap..."

# Install Homebrew if missing
if ! command -v brew &>/dev/null; then
    echo "==> Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install packages from Brewfile
echo "==> Installing Homebrew packages..."
brew bundle --global

# Install VS Code extensions
VSCODE_EXT_LIST="$HOME/.config/yadm/vscode-extensions.txt"
VSCODE_BIN="/Applications/Visual Studio Code.app/Contents/Resources/app/bin/code"
if [ -x "$VSCODE_BIN" ] && [ -f "$VSCODE_EXT_LIST" ]; then
    echo "==> Installing VS Code extensions..."
    while IFS= read -r extension; do
        [ -n "$extension" ] && "$VSCODE_BIN" --install-extension "$extension" --force
    done < "$VSCODE_EXT_LIST"
else
    echo "==> Skipping VS Code extensions (VS Code not found or extension list missing)"
fi

# Set zsh as default shell if needed
if [ "$SHELL" != "$(which zsh)" ]; then
    echo "==> Setting zsh as default shell..."
    chsh -s "$(which zsh)"
fi

echo "==> Bootstrap complete!"
